* install  on a workstation
** init environment

#export SRC_DIR=/project/k01/kortass/CLE6/KSLHUB_TEST3/
#export SRC_DIR=/project/k01/kortass/CLE6/KSLHUB_TEST4/
export SRC_DIR=$PWD
export CONDA_DIR=$SRC_DIR/env
export HUB_PORT=8888
git clone git@github.com:samkos/kslhub.git $SRC_DIR
cd $SRC_DIR


*** install miniconda 3.7
cd $SRC_DIR
mkdir -p BUILD/MINICONDA
cd BUILD/MINICONDA
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x ./Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh -p $SRC_DIR/miniconda -b

export CONDA_DEFAULT_ENV=$SRC_DIR/miniconda
export CONDA_PREFIX=$SRC_DIR/miniconda
export PATH=$CONDA_DEFAULT_ENV/bin:$PATH
export MANPATH=$CONDA_DEFAULT_ENV/share/man:MANPATH
export LD_LIBRARY_PATH=$CONDA_DEFAULT_ENV/lib:$LD_LIBRARY_PATH
export INCLUDE=$CONDA_DEFAULT_ENV/include:$INCLUDE

*** load miniconda correponding module
ml miniconda/3.7
source activate  $CONDA_DIR

** installing

conda create -y -p $CONDA_DIR pip python=3.7 
source activate  $CONDA_DIR
conda install -y -c  conda-forge/label/cf201901 configurable-http-proxy==3.1.0 nodejs==8.10
conda install -y jupyterlab jupyterhub=0.9.4
jupyter labextension install  @jupyterlab/hub-extension 
jupyter labextension install  @jupyter-widgets/jupyterlab-manager   jupyter-matplotlib


** running from pip package
pip install kslhub
kslhub -h
kslhub --init
kslhub --port $HUB_PORT -f kslhub_config_slurm.py


** debugging on WS
\rm -rf $CONDA_DIR/lib/python3.7/site-packages/jupyterhub*
\rm -rf $CONDA_DIR/lib/python3.7/site-packages/kslhub*
pip install kslhub

#\rm -rf $CONDA_DIR/share/*hub

which kslhub

cd $CONDA_DIR/lib/python3.7/site-packages

\rm -rf $CONDA_DIR/lib/python3.7/site-packages/jupyterhub*
ln -s $SRC_DIR/KSLHUB_GITHUB/jupyterhub/jupyterhub .


\rm -rf $CONDA_DIR/lib/python3.7/site-packages/kslhub*
ln -s $SRC_DIR/KSLHUB_GITHUB/kslhub .

cd $SRC_DIR/KSLHUB_GITHUB/jupyterhub/jupyterhub
ln -s ../jupyterhub .

** running
cd $SRC_DIR
#jupyterhub --port $HUB_PORT -f kslhub_config_direct.py

kslhub --port $HUB_PORT -f kslhub_config_slurm.py
error --> 'error no user identified  

** installation of wrapspwaner optional
git clone https://github.com/jupyterhub/wrapspawner
cd wrapspawner
pip install -r requirements.txt
python setup.py build
python setup.py install

pip install batchspawner







# create dist and wheel file and push to test.pypi
module load python/3.6.4
ml python/3.7.2

* test locally

#ml python/miniconda3-4.5.12
#\rm -rf /home/kortass/KSLHUB_TEST/env
#conda create -y -p /home/kortass/KSLHUB_TEST/env 'python==3.6 ' pip
. /home/kortass/APPS/miniconda3-4.5.12/etc/profile.d/conda.sh
conda activate //home/kortass/KSLHUB_TEST/env
# to install and test locally
pip install -e .
# to install in the local python directory
pip install .

* make package and push it on pypi

# make a pakage and push it
cd //home/kortass/KSLHUB
\rm -rf dist/*
python setup.py sdist bdist_wheel
#twine upload  -r test dist/*
#twine upload   dist/*


# to install from a package made
cd /home/kortass/KSLHUB_TEST
\rm -rf /home/kortass/KSLHUB_TEST/env_test
ml python/miniconda3-4.5.12
conda create -y -p /home/kortass/KSLHUB_TEST/env_test 'python>=3 ' pip
. /home/kortass/APPS/miniconda3-4.5.12/etc/profile.d/conda.sh
conda activate /home/kortass/KSLHUB_TEST/env_test
pip install dist/ksl*tar.gz

kslhub -h
kslhub --init
kslhub --generate-job-templates
kslhub


pip install -i https://test.pypi.org/simple -i https://pypi.org/simple kslhub==0.0.10

* install in docker
** conda container
docker run -t -i -d -p 9003:9000 --name conda continuumio/anaconda3
d cp /home/kortass/KSLHUB/dist/ksl*tar.gz conda:/root
db conda
qpt-get update
apt install -y gcc
conda install configurable-http-proxy
pip install kslhub

pip install /root/ksl*tar.gz








** build container 
cd docker
# docker build --no-cache - t kslhub .
docker build -t slurm-docker-cluster:17.02.11 -f Dockerfile_cluster .
#docker build -t kslhub -f Dockerfile_kslhub .
docker build -t kslhub_slurm -f Dockerfile_kslhub_slurm .
#docker run -h kslhub -t -i kslhub 
docker run -h kslhub  -t -i --privileged -p 8000:8000 -p 33333:22 kslhub_slurm 

** run on container
ssh hub
kslhub -f kslhub/config/kslhub_config_docker_slurm.py



* compile the documentation
# to compile the documentation
cd docs
pip  install sphinx
pip  install sphinx_rtd_theme
make html

python -m compileall -f .

* develop/debug

\rm -rf /home/kortass/KSLHUB_TEST/env/lib/python3.6/site-packages/jupyterhub*
\rm -rf /home/kortass/KSLHUB_TEST/env/lib/python3.6/site-packages/kslhub*
\rm -rf /home/kortass/KSLHUB_TEST/env/share/*hub

cd /home/kortass/KSLHUB
pip install .

cd /home/kortass/KSLHUB_TEST/env/lib/python3.6/site-packages
# mv jupyterhub jupyterhub-orig
# ln -s /home/kortass/KSLHUB/kslhub /home/kortass/KSLHUB/jupyterhub/jupyterhub .

\rm -rf /home/kortass/KSLHUB_TEST/env/lib/python3.6/site-packages/kslhub*
ln -s /home/kortass/KSLHUB/kslhub .

cd /home/kortass/KSLHUB/jupyterhub/jupyterhub
ln -s ../jupyterhub .

cd /home/kortass/KSLHUB_TEST/env/share
\rm -rf kslhub
mkdir kslhub 
ln -s /home/kortass/KSLHUB/kslhub/templates kslhub
ln -s /home/kortass/KSLHUB/kslhub/config.py kslhub

export PYTHONPATH=/home/kortass/KSLHUB/jupyterhub:$PYTHONPATH

cd ~/TMP
kslhub 
kslhub -f shaheen_config.py



* develop/debug on shaheen
CONDA_DIR=/project/k01/kortass/CLE6/KSLHUB_TEST/env
ml miniconda/3.7
source activate  $CONDA_DIR

\rm -rf $CONDA_DIR/lib/python3.*/site-packages/jupyterhub*
\rm -rf $CONDA_DIR/lib/python3.*/site-packages/kslhub*
\rm -rf $CONDA_DIR/share/*hub

cd /project/k01/kortass/CLE6/KSLHUB_TEST/KSLHUB_GITHUB
pip install .

cd $CONDA_DIR/lib/python3.*/site-packages
# mv jupyterhub jupyterhub-orig
# ln -s /home/kortass/KSLHUB/kslhub /home/kortass/KSLHUB/jupyterhub/jupyterhub .

\rm -rf $CONDA_DIR/lib/python3.*/site-packages/kslhub*
ln -s /home/kortass/KSLHUB/kslhub .

cd /home/kortass/KSLHUB/jupyterhub/jupyterhub
ln -s ../jupyterhub .

cd $CONDA_DIR/share
\rm -rf kslhub
mkdir kslhub 
ln -s /home/kortass/KSLHUB/kslhub/templates kslhub
ln -s /home/kortass/KSLHUB/kslhub/config.py kslhub

export PYTHONPATH=/home/kortass/KSLHUB/jupyterhub:$PYTHONPATH

cd ~/TMP
kslhub 
kslhub -f shaheen_config.py


* finish installation of jupyterhub
 
# installing NERSC slurm magic  kernel
mkdir -p $SW_BLDDIR/BUILD
cd $SW_BLDDIR/BUILD
git clone https://github.com/NERSC/slurm-magic.git
cd slurm-magic
python setup.py install

cd $SW_BLDDIR/BUILD
jupyter-kernelspec install slurm-magic --sys-prefix

# configuring the extension 
jupyter contrib nbextension install  --sys-prefix
jupyter nbextensions_configurator enable --sys-prefix
jupyter nbextension enable codefolding/main
jupyter nbextension enable --py --sys-prefix widgetsnbextension
#jupyter labextension install @jupyter-widgets/jupyterlab-manager

# configuring the working directory

mkdir -p /scratch/tmp/kslhub/runtime/jupyter /scratch/tmp/kslhub/jobs /scratch/tmp/kslhub/logs
cd $SW_BLDDIR
chmod 3777 runtime jobs logs

ln -s /scratch/tmp/kslhub/runtime .
ln -s /scratch/tmp/kslhub/jobs .
ln -s /scratch/tmp/kslhub/logs .


chmod 3777 $SW_BLDDIR/jobs
chmod 3777 $SW_BLDDIR/runtime/jupyter

  drwxrwxrwt     5 root        root          2822144 Mar 14 15:39 tmp
           ^ sticky bit





* run kslhub
kslhub --init

kslhub --start -f /home/kortass/KSLHUBkslhub/config.py

* documentation
pip install sphinx sphinx_rtd_theme
cd docs
make html



*
/usr/bin/ssh-keygen -A
